function bloodmallet_chart_import(){const e=["#7cb5ec","#d9d9df","#90ed7d","#f7a35c","#8085e9","#f15c80","#e4d354","#2b908f","#f45b5b","#91e8e1"],t="#343a40",o="#f8f9fa",r="#828282",i="1.1rem",l=!1,s="https://bfa.bloodmallet.com/json/";let a={};function n(e){l&&console.log("load_data");let t=e.data_type,o=e.fight_style,r=e.wow_class,i=e.wow_spec;try{if(a[t][o][r][i])return}catch(g){l&&console.log("Data needs to be loaded.")}let n=t;n.indexOf("azerite")>-1&&(n="azerite_traits");let d=r;d+="_"+i,t.indexOf("azerite_items")>-1&&(d+=t.replace("azerite_items","")),d+="_"+o,d+=".json",l&&console.log("Fetching data from: "+s+n+"/"+d);let c=new XMLHttpRequest;c.open("GET",s+n+"/"+d+"?"+(new Date).getTime(),!0),c.onload=function(e){if(4===c.readyState)if(200===c.status){let e=JSON.parse(c.responseText);a[t]||(a[t]={}),a[t][o]||(a[t][o]={}),a[t][o][r]||(a[t][o][r]={}),a[t][o][r][i]=e,l&&(console.log(e),console.log("Load and save finished."))}else console.error(c.statusText)};let g=!1;return c.onerror=function(e){console.error("Fetching data from bloodmallet.com encountered an error, ",e),g=!0},c.send(null),g}function d(e,t,o,r){l&&console.log("update_charts");let i=e.data_type,s=e.fight_style,n=e.wow_class,g=e.wow_spec,_=e.data_entries,p=e.chart_engine;try{var h=a[i][s][n][g]}catch(i){return void(r<10&&setTimeout(d,100,e,t,o,r+1))}const u=h;let m,f;if(i.indexOf("azerite_traits")>-1)if("azerite_traits_stacking"===i)"all"===e.azerite_tier?m=u.sorted_data_keys_2.slice(0,u.sorted_data_keys_2.length):"1"===e.azerite_tier||"3"===e.azerite_tier?m=u.sorted_azerite_tier_3_trait_stacking.slice(0,u.sorted_azerite_tier_3_trait_stacking.length):"2"===e.azerite_tier&&(m=u.sorted_azerite_tier_2_trait_stacking.slice(0,u.sorted_azerite_tier_2_trait_stacking.length)),f=u.data.baseline[u.simulated_steps[0]];else{if("azerite_traits_itemlevel"!==i)return void console.log("Chart found, but unknown data-type detected.");"all"===e.azerite_tier?m=u.sorted_data_keys.slice(0,u.sorted_data_keys.length):"1"===e.azerite_tier||"3"===e.azerite_tier?m=u.sorted_azerite_tier_3_itemlevel.slice(0,u.sorted_azerite_tier_3_itemlevel.length):"2"===e.azerite_tier&&(m=u.sorted_azerite_tier_2_itemlevel.slice(0,u.sorted_azerite_tier_2_itemlevel.length)),f=u.data.baseline[u.simulated_steps[u.simulated_steps.length-1]]}else"corruptions"===i&&"dps/rating"===e.corruption_representation?(m=u.sorted_data_keys_2.slice(0,u.sorted_data_keys_2.length),f=u.data.baseline[u.simulated_steps[0]]):(m=u.sorted_data_keys.slice(0,u.sorted_data_keys.length),f="races"===i?0:"essence_combinations"===i?u.data.baseline:u.data.baseline[u.simulated_steps[u.simulated_steps.length-1]]);l&&(console.log(m),console.log("Baseline dps: "+f));let b=[];if("azerite_traits_stacking"===i){let e=u.simulated_steps[0].replace("1_","");b.push("3_"+e),b.push("2_"+e),b.push("1_"+e)}else b=u.simulated_steps;if(l&&console.log("simulated_steps: "+b),"essences"===i){purge_list=[];for(let t of m)e.filters.hasOwnProperty("essence_types")&&(e.filters.essence_types.indexOf("minor")>-1&&t.indexOf(" minor")>-1?purge_list.push(t):e.filters.essence_types.indexOf("combined")>-1&&-1===t.indexOf(" minor")&&purge_list.push(t));for(let e of purge_list)m.splice(m.indexOf(e),1)}for(m=m.slice(0,_),o.setTitle({text:u.title},{text:u.subtitle},!1);o.series[0];)o.series[0].remove(!1);let y=[];for(let t=0;t<m.length;t++){let o=m[t];y.push(c(e,o,u))}if(l&&console.log(y),"highcharts"==p?o.update({xAxis:{categories:y}},!1):"highcharts_old"==p&&o.xAxis[0].setCategories(y,!1),b)for(let t=0;t<b.length;t++){let r=b[t];var w=[];for(let o=0;o<m.length;o++){r=b[t];let l=b.slice(),s=m[o],a=u.data[s];if(f="azerite_traits_stacking"===i?u.data.baseline[u.simulated_steps[0]]:"corruptions"===i?u.data.baseline[r]:u.data.baseline[u.simulated_steps[u.simulated_steps.length-1]],"azerite_traits_stacking"===i&&void 0===a[r]){let e=u.simulated_steps,t=void 0;for(let o=0;o<e.length;o++){const r=e[o];!t&&u.data[s][r]&&(t=r)}t=t.replace("1_",""),l=[];for(let e of b)l.push(e.split("_")[0]+"_"+t);f=u.data.baseline["1_"+t],r=r.split("_")[0]+"_"+t}if(Number(a[r])>0)if(t===b.length-1)r in a?"corruptions"===i&&"dps/rating"===e.corruption_representation?w.push((a[r]-f)/u.corruption_rating[s]):w.push(a[r]-f):w.push(0);else if("corruptions"===i&&"dps/rating"===e.corruption_representation){let e=(a[r]-f)/u.corruption_rating[s],o=l[String(Number(t)+1)],i=(a[o]-u.data.baseline[o])/u.corruption_rating[s];w.push(e-i)}else if("corruptions"===i){let e=a[r]-f,o=l[String(Number(t)+1)],i=a[o]-u.data.baseline[o];w.push(e-i)}else 0!==a[l[String(Number(t)+1)]]&&l[String(Number(t)+1)]in a?w.push(a[r]-a[l[String(Number(t)+1)]]):w.push(a[r]-f);else r in a?w.push(a[r]):w.push(0)}let l=r;["azerite_items_chest","azerite_items_head","azerite_items_shoulders","azerite_traits_itemlevel"].indexOf(i)>-1?l=r.split("_")[1]:"azerite_traits_stacking"===i&&(l=r.split("_")[0]),o.addSeries({data:w,name:l,showInLegend:!0},!1)}else{w=[];for(let t=0;t<m.length;t++){let o=m[t],r=0;if("corruptions"===i&&"dps/rating"===e.corruption_representation){let e="",t="";if(isNaN(parseInt(o.slice(o.length-1,o.length)))){e=o;let r=Object.keys(u.corruption_rating[e]);t=r.sort()[r.length-1]}else e=o.slice(0,o.length-2),t=o.slice(o.length-1,o.length);r=(u.data[e][t]-f)/u.corruption_rating[e][t]}else r=u.data[o];w.push(r)}let t="";"races"===i&&(t="Race"),o.addSeries({data:w,name:t,showInLegend:!0},!1)}"trinkets"==i||"azerite_items_chest"==i||"azerite_items_head"==i||"azerite_items_shoulders"==i||"azerite_traits_itemlevel"==i?o.legend.title.attr({text:"Itemlevel"}):"races"===i?o.legend.title.attr({text:""}):"azerite_traits_stacking"===i?o.legend.title.attr({text:"Trait count"}):"essences"===i||"corruptions"===i&&"dps"===e.corruption_representation?o.legend.title.attr({text:"Rank"}):o.legend.title.attr({text:""}),"corruptions"===i&&"dps/rating"===e.corruption_representation&&(o.yAxis[1].setTitle({text:"Δ Damage per second / corruption rating"}),o.yAxis[0].setTitle({text:"Δ Damage per second / corruption rating"})),t.style.height=200+30*m.length+"px","highcharts"==p&&o.setSize(t.style.width,t.style.height),o.redraw(),"highcharts_old"==p&&o.reflow(),"wowdb"==e.tooltip_engine&&setTimeout(function(){!function(e){l&&console.log("readd_wowdb_tooltips");try{CurseTips["wowdb-tooltip"].watchElements(document.getElementById(e).getElementsByTagName("a"))}catch(e){console.log("Setting wowdb (CurseTips) tooltips failed. Error: ",e)}}(t.id)},1)}function c(e,t,o){l&&(console.log("get_category_name"),console.log(t),console.log(o));const r={cn:"cn_CN",en:"en_US",de:"de_DE",es:"es_ES",fr:"fr_FR",it:"it_IT",ko:"ko_KR",pt:"pt_BR",ru:"ru_RU"};if("wowhead"!==e.tooltip_engine&&"wowdb"!==e.tooltip_engine)try{return o.languages[t][r[e.language]]}catch(e){return t}if("races"===e.data_type)try{return o.languages[t][r[e.language]]}catch(e){return t}if("wowhead"===e.tooltip_engine){let i=document.createElement("a");if(i.href="https://"+("en"===e.language?"www":e.language)+".wowhead.com/",o.hasOwnProperty("power_ids")&&(o.power_ids.hasOwnProperty(t)||o.power_ids.hasOwnProperty(t.split(" +")[0])))o.power_ids.hasOwnProperty(t)?i.href+="azerite-essence-power/"+o.power_ids[t]:o.power_ids.hasOwnProperty(t.split(" +")[0])&&(i.href+="azerite-essence-power/"+o.power_ids[t.split(" +")[0]]);else if(o.hasOwnProperty("item_ids")&&o.item_ids.hasOwnProperty(t)){if(i.href+="item="+o.item_ids[t]+"/"+g(t),o.hasOwnProperty("class_id")&&o.hasOwnProperty("used_azerite_traits_per_item")){i.href+="?azerite-powers="+o.class_id;for(let e=0;e<o.used_azerite_traits_per_item[t].length;e++){const r=o.used_azerite_traits_per_item[t][e];i.href+=":"+r.id}}let e=o.simulated_steps[o.simulated_steps.length-1];"string"==typeof e&&e.indexOf("_")>-1&&(e=e.split("_")[1]),i.href+="&ilvl="+e}else if(o.hasOwnProperty("spell_ids")&&o.spell_ids.hasOwnProperty(t))if("corruptions"===e.data_type){let e=t;i.href+="spell="+o.spell_ids[e]+"/"+g(t)}else i.href+="spell="+o.spell_ids[t]+"/"+g(t);try{i.appendChild(document.createTextNode(o.languages[t][r[e.language]]))}catch(e){i.appendChild(document.createTextNode(t)),console.log("Bloodmallet charts: Translation for "+t+" wasn't found. Please help improving the reasource at bloodmallet.com.")}return i.outerHTML}if("wowdb"==e.tooltip_engine){let i=document.createElement("a");i.href="http://www.wowdb.com/";try{i.href+="items/"+o.item_ids[t]}catch(e){l&&(console.log(e),console.log("We're probably looking at a spell."))}if(i.href.indexOf("items")>-1){let e=o.simulated_steps[o.simulated_steps.length-1];if("string"==typeof e&&e.indexOf("_")>-1&&(e=e.split("_")[1]),i.href+="?itemLevel="+e,o.hasOwnProperty("class_id")&&o.hasOwnProperty("used_azerite_traits_per_item")){i.href+="&azerite=",i.href+=o.class_id+":0";for(let e=0;e<o.used_azerite_traits_per_item[t].length;e++){const r=o.used_azerite_traits_per_item[t][e];i.href+=":"+r.id}}}else try{if("essence_combinations"===e.data_type)i.href+="spells/"+o.spell_ids[t.split(" +")[0]];else if("corruptions"===e.data_type&&"dps/rating"===e.corruption_representation){let e=t;i.href+="spells/"+o.spell_ids[e]}else"corruptions"===e.data_type&&"dps"===e.corruption_representation?i.href+="spells/"+o.spell_ids[t][1]:i.href+="spells/"+o.spell_ids[t]}catch(e){l&&(console.log(e),console.log("We're probably looking at an item."))}i.dataset.tooltipHref=i.href;try{i.appendChild(document.createTextNode(o.languages[t][r[e.language]]))}catch(e){i.appendChild(document.createTextNode(t)),console.log("Bloodmallet charts: Translation for "+t+" wasn't found. Please help improving the reasource at bloodmallet.com.")}return i.outerHTML}}function g(e){return e.toString().toLowerCase().replace(/\s+/g,"-").replace(/[^\w\-]+/g,"").replace(/\-\-+/g,"-").replace(/^-+/,"").replace(/-+$/,"")}function _(s){if(l&&console.log("update_chart_style"),"highcharts"==s.chart_engine||"highcharts_old"==s.chart_engine){let l=s.background_color,a=s.axis_color,n=s.font_color,d={chart:{type:"bar",backgroundColor:t,style:{fontFamily:'-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"'}},colors:e,credits:{href:"https://bloodmallet.com/",text:"bloodmallet.com",style:{fontSize:i}},legend:{align:"right",backgroundColor:t,borderColor:r,borderWidth:1,floating:!1,itemMarginBottom:3,itemMarginTop:0,layout:"vertical",reversed:!0,shadow:!1,verticalAlign:"middle",x:0,y:0,itemStyle:{color:o},itemHoverStyle:{color:o},title:{text:" ",style:{color:o}},symbolRadius:0},plotOptions:{bar:{dataLabels:{enabled:!1}},series:{stacking:"normal",borderColor:t,events:{legendItemClick:function(){return!1}},style:{textOutline:!1,fontSize:i}}},series:[],title:{text:"Loading data...",useHTML:!0,style:{color:o,fontSize:i}},subtitle:{text:'...from <a href="https://bloodmallet.com">bloodmallet</a>',useHTML:!0,style:{color:o,fontSize:i}},tooltip:{headerFormat:"<b>{point.x}</b>",shared:!0,backgroundColor:t,borderColor:r,style:{color:o,fontSize:i},useHTML:!0,positioner:function(e,t,o){return{x:o.plotX,y:o.plotY}}},xAxis:{categories:["","","","",""],labels:{useHTML:!0,style:{color:o,fontSize:i}},gridLineWidth:0,gridLineColor:r,lineColor:r,tickColor:r},yAxis:[{labels:{style:{color:r}},min:0,stackLabels:{enabled:!0,formatter:function(){return Intl.NumberFormat().format(this.total)},style:{color:o,textOutline:!1,fontSize:i,fontWeight:"normal"}},title:{text:"Δ Damage per second",style:{color:r}},gridLineWidth:1,gridLineColor:r},{linkedTo:0,opposite:!0,labels:{style:{color:r}},min:0,stackLabels:{enabled:!0,formatter:function(){return Intl.NumberFormat().format(this.total)},style:{color:o,textOutline:!1,fontSize:i,fontWeight:"normal"}},title:{text:"Δ Damage per second",style:{color:r}},gridLineWidth:1,gridLineColor:r}]};return d.chart.backgroundColor=l,d.legend.backgroundColor=l,d.legend.borderColor=a,d.legend.itemStyle.color=n,d.legend.itemHoverStyle.color=n,d.title.style.color=n,d.subtitle.style.color=n,d.tooltip.formatter=function(){let e=document.createElement("div");e.style.margin="-4px -7px -7px -7px",e.style.padding="3px 3px 6px 3px",e.style.backgroundColor=l,"highcharts_old"===s.chart_engine&&(e.style.margin="-7px");let t=document.createElement("div");e.appendChild(t),t.style.marginLeft="9px",t.style.marginRight="9px",t.style.marginBottom="6px",t.style.fontWeight="700",t.innerHTML=this.x;let o=0;for(var r=this.points.length-1;r>=0;r--)if(o+=this.points[r].y,0!==this.points[r].y){let t=document.createElement("div");e.appendChild(t);let i=document.createElement("span");t.appendChild(i),i.style.marginLeft="9px",i.style.borderLeft="9px solid "+this.points[r].series.color,i.style.paddingLeft="4px",i.innerHtml=this.points[r].series.name,t.appendChild(document.createTextNode("  "+Intl.NumberFormat().format(o)))}return e.outerHTML},d.tooltip.backgroundColor=l,d.tooltip.borderColor=a,d.tooltip.style.color=n,d.xAxis.labels.style.color=n,d.xAxis.gridLineColor=a,d.xAxis.lineColor=a,d.xAxis.tickColor=a,d.yAxis[0].labels.style.color=a,d.yAxis[0].stackLabels.style.color=n,d.yAxis[0].gridLineColor=a,d.yAxis[0].lineColor=a,d.yAxis[0].tickColor=a,d.yAxis[0].title.style.color=a,d.yAxis[1].labels.style.color=a,d.yAxis[1].stackLabels.style.color=n,d.yAxis[1].gridLineColor=a,d.yAxis[1].lineColor=a,d.yAxis[1].tickColor=a,d.yAxis[1].title.style.color=a,d.credits.style.color=n,d}}this.init_charts=new function(){l&&console.log("init_charts");let e=document.querySelectorAll("div.bloodmallet_chart, [data-bloodmallet='chart']");for(let s=0;s<e.length;s++){const a=e[s];if(a){var i={wow_class:void 0,wow_spec:void 0,data_type:"trinkets",azerite_tier:"all",fight_style:"patchwerk",corruption_representation:"dps",filters:{},axis_color:r,background_color:t,font_color:o,data_entries:7,chart_engine:"highcharts",tooltip_engine:"wowhead",language:"en"};try{void 0!==bloodmallet.style.axis_color&&(i.axis_color=bloodmallet.style.axis_color),void 0!==bloodmallet.style.background_color&&(i.background_color=bloodmallet.style.background_color),void 0!==bloodmallet.style.font_color&&(i.font_color=bloodmallet.style.font_color),void 0!==bloodmallet.settings.entries&&(i.data_entries=bloodmallet.settings.entries),void 0!==bloodmallet.settings.chart_engine&&(i.chart_engine=bloodmallet.settings.chart_engine),void 0!==bloodmallet.settings.tooltip_engine&&(i.tooltip_engine=bloodmallet.settings.tooltip_engine),void 0!==bloodmallet.settings.language&&(i.language=bloodmallet.settings.language),void 0!==bloodmallet.settings.corruption_representation&&(i.corruption_representation=bloodmallet.settings.corruption_representation)}catch(e){l&&console.log("Applying page wide settings failed.")}a.getAttribute("data-entries")&&(i.data_entries=a.getAttribute("data-entries")),a.getAttribute("data-fight-style")&&(i.fight_style=a.getAttribute("data-fight-style")),a.getAttribute("data-type")&&(i.data_type=a.getAttribute("data-type")),a.getAttribute("data-azerite-tier")&&(i.azerite_tier=a.getAttribute("data-azerite-tier")),a.getAttribute("data-background-color")&&(i.background_color=a.getAttribute("data-background-color")),a.getAttribute("data-font-color")&&(i.font_color=a.getAttribute("data-font-color")),a.getAttribute("data-axis-color")&&(i.axis_color=a.getAttribute("data-axis-color")),a.getAttribute("data-tooltip-engine")&&(i.tooltip_engine=a.getAttribute("data-tooltip-engine")),a.getAttribute("data-chart-engine")&&(i.chart_engine=a.getAttribute("data-chart-engine")),a.getAttribute("data-corruption-representation")&&(i.corruption_representation=a.getAttribute("data-corruption-representation")),a.getAttribute("data-language")&&(i.language=a.getAttribute("data-language")),a.getAttribute("data-filter-essence-types")&&(i.filters.essence_types=a.getAttribute("data-filter-essence-types").split(";"));let e=!0;a.getAttribute("data-wow-class")||(console.error("Required 'data-wow-class' attribute wasn't found in the following element."),console.log(a),e=!1),i.wow_class=a.getAttribute("data-wow-class"),a.getAttribute("data-wow-spec")||(console.error("Required 'data-wow-spec' attribute wasn't found in the following element."),console.log(a),e=!1),i.wow_spec=a.getAttribute("data-wow-spec");let s=_(i),c=!1;if("highcharts"==i.chart_engine)try{c=Highcharts.chart(a,s)}catch(e){return console.error("When trying to create a highcharts chart the following error occured. Did you include the necessary Highcharts scripts?"),void console.log(e)}else if("highcharts_old"==i.chart_engine)try{let e=s;e.chart.renderTo=a,c=new Highcharts.Chart(e)}catch(e){return console.error("When trying to create a highcharts_old chart the following error occured. Did you include the necessary Highcharts scripts?"),void console.log(e)}if(e){!0===n(i)?c.setTitle({text:"Connection error"},{text:"Establishing a connection to bloodmallet.com failed. Is the website blocked?"},!1):setTimeout(d,0,i,a,c,0)}else c.setTitle({text:"Wrong chart setup"},{text:"Missing 'data-wow-class' or 'data-wow-spec'. See <a href=\"https://github.com/Bloodmallet/bloodmallet.github.io/wiki/How-to-import-charts-or-data\">wiki</a>"})}}}}document.addEventListener("DOMContentLoaded",function(){bloodmallet_chart_import()});